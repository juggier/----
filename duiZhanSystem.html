<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>兵棋推演对战系统</title>
    
    <link rel="stylesheet" href="../-----/css/base.css">
    <link rel="stylesheet" href="../-----/css/reset.css">
    <link rel="stylesheet" href="../-----/css/duiZhanSystem.css">
    <script type="text/javascript" src="../-----/js/tool.js"></script>
    <script type="text/javascript" src="../-----/js/duiZhanSystem.js"></script>
    <script type="text/javascript" src="../-----/js/Ai_Control.js"></script>
    <script src="http://ajax.aspnetcdn.com/ajax/jQuery/jquery-1.8.0.js"></script>

    <style>
        #Map{
            position: absolute;
            z-index: 0;
        }
    </style>

</head>
<body>
    
    <canvas id = "Map"></canvas>
    <div id="window-map" class="window-map">

            <!-- 顶部导航栏 -->
        <div class="topbar">
            <!-- 左上角logo -->
            <div class="logo">
                <!-- <h1>兵棋推演复盘系统</h1> -->
            </div>
            <!-- 中间的步骤显示 -->
            <div class="time-bar">
                <div class="step">第<span id="ShowStep">xxxxx</span>步</div>
                <div class="time"><span>5</span>秒/步</div>
            </div>
            <!-- 顶部右侧菜单 -->
            <div id="topbar-right" class="topbar-right">
                <ul>
                    <li>

                        <a class="onloadButton" href="javascript:;">
                            <img src="../-----/img/右上角组件/测量.png" alt="测量">
                        </a>
    
                        <div id = "container">
                            <input type="radio" class="input_radio" name="inputType" id="inputType" value="1" checked>生成地图 <br>
                            <input type="radio" class="input_radio" name="inputType" id="inputType" value="2">导入地图 <br>
                            <input id="input" type="file">
                            <input id ="export" type="button" value="导出地图">
                            <input id="generate" type="button" value="生成地图">
                            <div id = "labels"></div>
                        </div>
                    </li>
                    <li>
                        <a class="direct" href="javascript:;">
                            <img src="../-----/img/右上角组件/模型.png" alt="模型">
                        </a>
                    </li>
                    <li>
                        <a href="javascript:;">
                            <img src="../-----/img/右上角组件/兵力.png" alt="兵力">
                        </a>
                    </li>
                    <li>
                        <a href="javascript:;">
                            <img src="../-----/img/右上角组件/开始.png" alt="开始">
                        </a>
                    </li>
                </ul>
            </div>
    
        </div>
    
        <!-- 左侧导航栏 -->
        <div class="left-bar-wrapper">
    
        
            <div class="left-bar">
                <button class="mStrength">兵力编成</button>
                <div class="blue-box">蓝方</div>
                <div id="Chess_list_blue" class="blue-data">

                </div>
                <div class="red-box">红方</div>
                <div id="Chess_list_red" class="red-data">

                </div>
             </div>
    
        </div>
    
        <!-- 右侧导航栏 -->
        <div class="right-bar">
            <div class="right-menu">
                <button class="score-button">比分裁决</button><br>
                <button class="right-button">状态</button><br>
                <button class="right-button">武器</button><br>
                <button class="right-button">播报</button><br>
                <button class="right-button">控制</button><br>
                <button class="right-button">间瞄</button><br>
                <button class="right-button">任务</button>
            </div>
            <div class="pannal">
                <h2>夺空点得分</h2>
                <div>
                    <h3 class="blue-s" id="PointScore_blue">123</h3>
                    <h3 class="red-s" id="PointScore_red">123</h3>
                </div>
    
                <h2>剩余算子得分</h2>
                <div>
                    <h3 class="blue-s" id="LeftChessScore_blue">123</h3>
                    <h3 class="red-s" id="LeftChessScore_red">123</h3>
                </div>
    
                <h2>战斗得分</h2>
                <div>
                    <h3 class="blue-s" id="BattleScore_blue">123</h3>
                    <h3 class="red-s" id="BattleScore_red">123</h3>
                </div>
    
                <h2>净胜分</h2>
                <div>
                    <h3 class="blue-s" id="DScore_blue">123</h3>
                    <h3 class="red-s" id="DScore_red">123</h3>
                </div>
    
                <h2>总得分</h2>
                <div>
                    <h3 class="blue-s" id="SumScore_blue">123</h3>
                    <h3 class="red-s" id="SumScore_red">123</h3>
                </div>
    
            </div>
        </div>


        <div>
            <p>武器选择:</p>
            <div id="weapon_information">

            </div>
        </div>
        <input id="exportInfor" type="button" value="导出数据">

        <!-- 底部 -->
        <div class="bottom-wrapper">
            
            <!-- 底部左侧 -->
            <div class="bottom-left"> <font id="bottom-left" size ="4" color = "#FFFFFF" > xy </font></div>



            <!-- 底部右侧菜单 -->
            <div class="bottom-right">


                <ul>
                    <li>
                        <button id="move_button">
                            <img src="../-----/img/右下角组件/机动.png" alt="机动">
                        </button>
                    </li>

                    <li>
                        <button id="attack_button">
                            <img src="../-----/img/右下角组件/打击.png" alt="打击">
                        </button>
                    </li>

                    <li>
                        <button>
                            <img src="../-----/img/右下角组件/上车.png" alt="上车">
                        </button>
                    </li>

                    <li>
                        <button>
                            <img src="../-----/img/右下角组件/掩蔽.png" alt="掩蔽">
                        </button>
                    </li>

                    <li>
                        <button>
                            <img src="../-----/img/右下角组件/停止.png" alt="停止">
                        </button>
                    </li>
                </ul>
            </div>
        </div>    

    </div>
</body>


<script type="module">

    //导入Map库
    import { Map } from '../-----/tools/Map.js';
    import { AStar } from '../-----/js/AStar.js';
    //import { AI_Control } from '../js/Ai_Control.js';

    //-----------------
    var ThisPiece = { //组件信息数组标准："information"：[id,name,health,defense,move_speed,cooling,armour,visibility]
            "information": [],
            "id": null,
            "weapon_id": [],
            "position":{},
        } //获取当前选择棋子的信息
    var This_piece_weapon = {} //存储当前棋子可用的武器信息
    var choose_weapon_obj = []; //存储选择的武器信息，用于攻击数值传递
    var EnemyPiece = {
            "information": [],
            "position": {},
        } 
        //存储被攻击的敌方单位信息
    var begin_attack = false;//确定是否摁下打击按钮
    var begin_move = false;//确定是否摁下移动按钮
    //-----------------


    //------------比分界面-------------//
    var PointScore_blue = document.getElementById("PointScore_blue");
    var PointScore_red = document.getElementById("PointScore_red");
    var LeftChessScore_blue = document.getElementById("LeftChessScore_blue");
    var LeftChessScore_red = document.getElementById("LeftChessScore_red");
    var BattleScore_blue = document.getElementById("BattleScore_blue");
    var BattleScore_red = document.getElementById("BattleScore_red");
    var DScore_blue = document.getElementById("DScore_blue");
    var DScore_red = document.getElementById("DScore_red");
    var SumScore_blue = document.getElementById("SumScore_blue");
    var SumScore_red = document.getElementById("SumScore_red");

    var ShowStep = document.getElementById("ShowStep");
    //-------------------------------//

    //-----------兵力信息-------------//
    var Chess_list_blue = document.getElementById("Chess_list_blue");
    var Chess_list_red = document.getElementById("Chess_list_red");
    //-------------------------------//


    var RedPointScore = 0;
    var BluePointScore = 0;

    var RedLeftChessScore = 0;
    var BlueLeftChessScore = 0;

    var RedBattleScore = 0;
    var BlueBattleScore = 0;

    var BlueDScore = 0;
    var RedDScore = 0;

    var RedScore = 0;
    var BlueScore = 0;
    //-------------

    //-------------
    var time = 0;
    var step = 0;
    
    var BroadCast_Key = 0;
    
    var Chesses_Infor_array = [];
    var Chesses_Infor_obj = {};

    var Replay_BroadCast_array = [];
    var Replay_BroadCast_obj = {};

    var All_RePlay_Information= {};

    var Begin_Game = false;
    //-------------


    main()

    function main()
    {
        //新建Map实例
        var map = new Map("#Map",window);
        console.log(map);

        //--------------
        var attack_button = document.getElementById("attack_button");
        var move_button = document.getElementById("move_button");
        attack_button.onclick = function(){ 
        //攻击按钮判断，判断是否选取了武器，当前选择的单位是否处于冷却之中
            if(choose_weapon_obj!=null)
            {
                for (var key in map.red_chesses.children) 
                {
                    if (ThisPiece.information[0] == map.red_chesses.children[key].information[0]) {
                        var cooling = map.red_chesses.children[key].information[5];
                    }
                }
                if (cooling > 0) 
                {
                    alert("冷却中 , "+"冷却时间还有："+ cooling);
                } 
                else {
                    begin_attack = true;
                    //alert(begin_attack);
                }
            }
        }
        move_button.onclick = function(){
            for(let key in ThisPiece.position)
            { 
                console.log("可以移动");
                setTimeout(function(){begin_move = true;},100);
            }
        }
        //--------------


        //判断类型
        let type = 1;
        const radio = document.getElementsByName("inputType");
        radio[0].onclick = function(){

            type = radio[0].value;

        };
        radio[1].onclick = function () {

            type = radio[1].value;

        };
        
        //生成地图或者导入地图
        const input = document.querySelector('input[type=file]');
        input.addEventListener('change',()=>{

            //map.GenerateMap(result);

            const reader = new FileReader();
            reader.readAsBinaryString(input.files[0]);
            reader.onload = ()=>{

                const result = reader.result;

                if(type == 1){
                    //生成地图的函数
                    map.GenerateMap(result);

                }else if(type == 2){
                    //导入地图的函数
                    map.InputMap(result);
                }
            }
            console.log("开始游戏");
            //导入地图后五秒才启动ai
            setTimeout(AI_Way_Control,5000); 
            Begin_Game = true;

        },false);

        //按钮事件
        const botton = document.querySelector('#export');
        botton.addEventListener('click', e =>{
            map.mapToJson(botton,e) //导出地图的函数
            },false);

        //按钮事件
        const botton2 = document.querySelector('#generate');
        botton2.addEventListener('click', e => {
            const reader = new FileReader();
            reader.readAsBinaryString("./Mapheight.txt");
            reader.onload = () => {
                const result = reader.result;
                map.GenerateMap(result);
            }
            

        }, false);

        //获取当前棋子信息 //获取被攻击棋子信息 //存储造成的冷却与造成的伤害 //攻击事件
    window.addEventListener('click',e=>
    {
        var nowChess = map.curChess;
        //getmap(this.hex_map.children);
        if(nowChess)
        {
            if(nowChess.color == "red")
            {
                ThisPiece = { //组件信息数组标准："information"：[id,name,health,defense,move_speed,cooling,armour,visibility]
                                "information": [],
                                "id": null,
                                "weapon_id": [],
                                "position":{},
                            }
                
                for(var i = 0 ; i<nowChess.information.length;i++)
                {
                    ThisPiece.information[i] = nowChess.information[i];
                }
                for(var i = 0; i<nowChess.weapon_id[i];i++)
                {
                    ThisPiece.weapon_id[i] = nowChess.weapon_id[i]
                }

                ThisPiece.position = {};
                ThisPiece.position["row"] = map.curRow;
                ThisPiece.position["col"] = map.curColume; 
                console.log(ThisPiece.position);

                
                ClearElement("weapon_information");
                getweapon(ThisPiece.weapon_id);

                //****************************************************************
                getReplayInformation();
                //****************************************************************
                
            }//己方（red）
            if(nowChess.color == "blue")
            {
                if(begin_attack != false)
                {
                    //alert("已选取敌方单位");
                    for(var i = 0 ; i<nowChess.information.length ; i++)
                    {
                        EnemyPiece.information[i] = nowChess.information[i];
                    }
                    //alert("已读取敌方信息："+EnemyPiece.information);

                    for(var key in map.blue_chesses.children)
                    {
                        if(nowChess.information[0] == map.blue_chesses.children[key].information[0])
                        {
                            //alert("已寻找到敌方单位所在数据位置："+map.blue_chesses.children[key].information);
                            var harm = null;
                            harm = cal_harm();
                            //alert("造成了伤害："+harm);

                            if (harm == null) 
                            {
                                alert("不能击穿装甲");
                                add_cooling();

                                //---------------RePlay
                                //*******************************************************************************
                                console.log(ThisPiece.information[1] + " 使用了 " + choose_weapon_obj[1] +
                                " 对敌方单位 " + map.blue_chesses.children[key].information[1] + " 但没击穿其装甲 ");

                                getRePlayBroadCast(ThisPiece.information[1] + " 使用了 " + choose_weapon_obj[1] +
                                " 对敌方单位 " + map.blue_chesses.children[key].information[1] + " 但没击穿其装甲 ")
                                //*******************************************************************************
                                //---------------RePlay
                            }
                            else 
                            {
                                map.blue_chesses.children[key].information[2] -= harm;
                                if(map.blue_chesses.children[key].information[2]<=0)//摧毁蓝方则加分
                                {
                                    map.blue_chesses.children[key].Destory();
                                    RedBattleScore += 10;

                                    //-------------RePlay
                                    //*******************************************************************************
                                    console.log(ThisPiece.information[1] + "摧毁了" + map.blue_chesses.children[key].name + 
                                    "红方因此加10分");

                                    getRePlayBroadCast(ThisPiece.information[1] + "摧毁了" + map.blue_chesses.children[key].name + 
                                    "红方因此加10分");
                                    //*******************************************************************************
                                    //-------------RePlay
                                }

                                //distory(Objectdate[key].information[2], Objectdate[key].information[1], Objectdate[key].information[0]);
                                add_cooling();
                                //信息显示：变成字符串可以直接交给网页显示\

                                //----------------RePlay
                                //*******************************************************************************
                                console.log(ThisPiece.information[1] + " 使用了 " + choose_weapon_obj[1] +
                                " 对敌方单位 " + map.blue_chesses.children[key].information[1] + " 造成了 " + harm + " 点伤害 ");
                                console.log(map.blue_chesses.children[key].information[1] + "'s health: " + map.blue_chesses.children[key].information[2]);

                                getRePlayBroadCast(ThisPiece.information[1] + " 使用了 " + choose_weapon_obj[1] +
                                " 对敌方单位 " + map.blue_chesses.children[key].information[1] + " 造成了 " + harm + " 点伤害 " +
                                " " + map.blue_chesses.children[key].information[1] + "'s health: " + map.blue_chesses.children[key].information[2]);
                                //*******************************************************************************
                                //----------------RePlay
                            }
                            begin_attack = false;
                        }
                    }
                }

                //****************************************************************
                getReplayInformation();
                //****************************************************************
            }
            //敌方（blue）
        }
    });
    
        //点击移动 -- 返回一个数组，记录路径的x(row)与y(col)值,例如：[{x,y},{x,y},{x,y}]
    window.addEventListener('click',e=>
    {
        if(map.curChessCategory == undefined && begin_move == true)
        {
            let thisrow = map.curRow;
            let thiscol = map.curColume;

            //*******************************************************************************
            //console.log(" 您将从：" + ThisPiece.position.row + ThisPiece.position.col +" 移动到： " + thisrow + thiscol);
            getRePlayBroadCast(ThisPiece.information[1] + " 将从：" + ThisPiece.position.row + ThisPiece.position.col +" 移动到： " + thisrow + thiscol)
            //*******************************************************************************


            let way = AStar(ThisPiece.position.row, ThisPiece.position.col, thisrow, thiscol);
            for(let key in map.red_chesses.children)
            {
                if(ThisPiece.information[0] == map.red_chesses.children[key].information[0])
                {
                    map.red_chesses.children[key].moveStack = way.reverse();
                }
            }

            begin_move = false;
            return way;

            //****************************************************************
            getReplayInformation();
            //****************************************************************
        }

    });

        //刷新Thispiece的信息
    function Flash()
    {
        if(ThisPiece.position != null)
        {
            for(let key in map.red_chesses.children)
            {
                if(ThisPiece.information[0] == map.red_chesses.children[key].information[0])
                {
                    ThisPiece.position.row = map.red_chesses.children[key].row;
                    ThisPiece.position.col = map.red_chesses.children[key].colume;
                    /* console.log("这是测试信息："+ThisPiece.position.row+"|||"+ThisPiece.position.col
                    +"|||"+map.red_chesses.children[key].row+"|||"+map.red_chesses.children[key].colume) */

                    ThisPiece.information = map.red_chesses.children[key].information;

                    if(ThisPiece.information[2] <= 0 )
                    {
                        ThisPiece = {
                                        "information": [],
                                        "id": null,
                                        "weapon_id": [],
                                        "position":{},
                                    }
                    }
                }
            }
        }
    }

        //增加冷却信息
    function add_cooling() {
        var cooling = choose_weapon_obj[5];
        for (var cooling_key in map.red_chesses.children) {
            //map.blue_chesses.children == objectdata
            //red_chess.children:{
            //    "1":{"information":[....],,,}
            //    "2":{"information":[....],,,}
            //          }
            //information[5]的数值为冷却

            if (map.red_chesses.children[cooling_key].information[0] == ThisPiece.information[0]) 
            {
                map.red_chesses.children[cooling_key].information[5] += cooling;
                console.log(map.red_chesses.children[cooling_key].information[1] + "的冷却时间还有：" + map.red_chesses.children[cooling_key].information[5]);
            }
        }
    }
        //计算冷却时间
    function cal_cooling() {
        for (let key in map.red_chesses.children) {
            if (map.red_chesses.children[key].information[5] != 0) {
                map.red_chesses.children[key].information[5] -= 1;
            }
            if (map.red_chesses.children[key].information[5] < 0) {
                map.red_chesses.children[key].information[5] = 0;
            }
        }
    }
        //AI路径（直接走向夺旗点）
    function AI_Way_Control() 
    {
        console.log("ai启动");
        let i = 0;

        for(let key in map.blue_chesses.children)
        {
            let way = AStar(map.blue_chesses.children[key].row,map.blue_chesses.children[key].colume,map.points[i][0],map.points[i][1]);
            map.blue_chesses.children[key].moveStack = way.reverse();
            i += 1;
        }

        //****************************************************************
        getReplayInformation();
        //****************************************************************
    }
        //AI攻击（进入范围直接造成随机伤害）
    function Fake_AI_Attack()
    {
        for(let Red_key in map.red_chesses.children)
        {
            for(let Blue_key in map.blue_chesses.children)
            {
                let ThisRedChessRow = map.red_chesses.children[Red_key].row;
                let ThisRedChessCol = map.red_chesses.children[Red_key].colume;
                let ThisBlueChessRow = map.blue_chesses.children[Blue_key].row;
                let ThisBlueChessCol = map.blue_chesses.children[Blue_key].colume;
                let Distance = Math.abs(ThisRedChessRow-ThisBlueChessRow) + Math.abs(ThisBlueChessRow-ThisBlueChessCol)

                /* 
                //以下为调用A*算法判断范围，但是这样要遍历周围很多格子，会有点卡，建议使用上方的简单范围判断
                let a = AStar(ThisRedChessRow,ThisRedChessCol,ThisBlueChessRow,ThisBlueChessCol);
                let Distance = a.length; 
                */

                //判断范围，并且自己没有死才行 ，并且不能鞭尸(由于distory函数只是隐藏该对象，并不是销毁)
                if(Distance <= 12 
                    && map.blue_chesses.children[Blue_key].information[2] != 0 
                    && map.red_chesses.children[Red_key].information[0] != 0 )
                {
                    
                    let AI_harm = 0;
                    AI_harm = Math.floor(Math.random()*2); //随机的伤害
                    map.red_chesses.children[Red_key].information[2] -= AI_harm;

                    //*******************************************************************************
                    getRePlayBroadCast(map.blue_chesses.children[Blue_key].name + " 在 "+Distance+" 距离上，对" + map.red_chesses.children[Red_key].name + 
                                "造成了 "+ AI_harm +" 点伤害");
                    getRePlayBroadCast(map.red_chesses.children[Red_key].name + "的剩余血量为："+ map.red_chesses.children[Red_key].information[2]);
                    //*******************************************************************************
                    
                    /* console.log(map.blue_chesses.children[Blue_key].name + " 在 "+Distance+" 距离上，对" + map.red_chesses.children[Red_key].name + 
                             "造成了 "+ AI_harm +" 点伤害");
                    console.log(map.red_chesses.children[Red_key].name + "的剩余血量为："+ map.red_chesses.children[Red_key].information[2]); */

                    //判断红方是否被摧毁,若是被摧毁，则蓝方加分
                    if(map.red_chesses.children[Red_key].information[2] <= 0)
                    {
                        map.red_chesses.children[Red_key].Destory();
                        BlueBattleScore += 10;

                        //*******************************************************************************
                        getRePlayBroadCast(map.blue_chesses.children[Blue_key].name + "摧毁了" + map.red_chesses.children[Red_key].name + 
                                    "蓝方因此加10分")
                        //*******************************************************************************

                        /* console.log(map.blue_chesses.children[Blue_key].name + "摧毁了" + map.red_chesses.children[Red_key].name + 
                                    "蓝方因此加10分"); */
                    }

                    //****************************************************************
                    getReplayInformation();
                    //****************************************************************
                }
            }
        }
    }
        //移动？总之每0.1秒遍历一遍 red_chesses 和 blue_chesses,调用一遍对方的Move（）
        //若是其中有棋子的路径没空，则进行移动（？）
        //移动完当前格以后，pop出一个最前面的
    function move_function()
        {
            for(let key in map.red_chesses.children)
            {
                map.red_chesses.children[key].move();
            }
            for(let key in map.blue_chesses.children)
            {
                map.blue_chesses.children[key].move();
            }
        }

    //计分函数
    function scoring()
    {
        for(let K1_blue in map.blue_chesses.children) // 蓝方夺旗分数计算
        {
            for(let K2_blue in map.points)
            {
                if(map.blue_chesses.children[K1_blue].row == map.points[K2_blue][0]  &&  
                    map.blue_chesses.children[K1_blue].colume == map.points[K2_blue][1] )
                {
                    BluePointScore += 0.2;
                    console.log(" 由于蓝方单位在夺旗点： "+ map.points[K2_blue] +" , 则蓝方分数加1。当下的蓝方分数为：" +BlueScore);
                }
            }
        }

        for(let K1_red in map.red_chesses.children) // 红方夺旗分数计算
        {
            for(let K2_red in map.points)
            {
                if(map.red_chesses.children[K1_red].row == map.points[K2_red][0]  &&  
                    map.red_chesses.children[K1_red].colume == map.points[K2_red][1] )
                {
                    RedPointScore += 0.2;
                    console.log(" 由于红方单位在夺旗点： "+ map.points[K2_red] +" , 则红方分数加一。当下的红方分数为：" +RedScore);
                }
            }
        }

        RedLeftChessScore = map.red_chesses.children.length * 10;
        BlueLeftChessScore = map.blue_chesses.children.length * 10;

        RedDScore = RedScore - BlueScore ;
        BlueDScore = BlueScore - RedScore; 

        RedScore = RedPointScore + RedBattleScore + RedLeftChessScore;
        BlueScore = BluePointScore + BlueBattleScore + BlueLeftChessScore;

        if(RedScore >= 70)
        {
            alert("红方获胜！！！");
            SaveDate();
            location.reload();
        }
        if(BlueScore >= 70)
        {
            alert("蓝方获胜！！！");
            SaveDate();
            location.reload();
        }
        
    }
    
    //显示信息（左侧兵力编成，右侧分数显示）
    function ShowInformation()
    {
        /* ---------右侧分数显示----------- */
        PointScore_blue.innerHTML = BluePointScore.toFixed(1);
        PointScore_red.innerHTML = RedPointScore.toFixed(1);
        LeftChessScore_blue.innerHTML = BlueLeftChessScore.toFixed(1);
        LeftChessScore_red.innerHTML = RedLeftChessScore.toFixed(1);
        BattleScore_blue.innerHTML = BlueBattleScore.toFixed(1);
        BattleScore_red.innerHTML = RedBattleScore.toFixed(1);
        DScore_blue.innerHTML = BlueDScore.toFixed(1);
        DScore_red.innerHTML = RedDScore.toFixed(1);
        SumScore_blue.innerHTML = BlueScore.toFixed(1);
        SumScore_red.innerHTML = RedScore.toFixed(1);
        /* ------------------------------- */


        /* -------左侧兵力编成显示--------- */
        ClearElement("Chess_list_red");
        ClearElement("Chess_list_blue");

        for(let key_red in map.red_chesses.children)
        {
            var Chess_list_red_button = document.createElement("button");
            Chess_list_red_button.type = "button"
            Chess_list_red_button.id = map.red_chesses.children[key_red].information[0];
            Chess_list_red_button.innerHTML = "name: " + map.red_chesses.children[key_red].information[1] + 
                " id: " + map.red_chesses.children[key_red].information[0];
            Chess_list_red_button.onclick = chooseChesses;
            Chess_list_red.appendChild(Chess_list_red_button);
        }
        for(let key_blue in map.blue_chesses.children)
        {
            var Chess_list_blue_button = document.createElement("button");
            Chess_list_blue_button.type = "button"
            Chess_list_blue_button.id = map.blue_chesses.children[key_blue].information[0],
            Chess_list_blue_button.innerHTML = "name: " + map.blue_chesses.children[key_blue].information[1] + 
                " id: " + map.blue_chesses.children[key_blue].information[0];
            //Chess_list_blue_button.onclick = chooseChesses;
            Chess_list_blue.appendChild(Chess_list_blue_button);
        }
        /* ------------------------------- */

    }

    function TimeScore()
    {
        if(Begin_Game == true)
        {
            time += 1;
        }
        step = Math.ceil(time/5);//五秒一步
        ShowStep.innerHTML = step;
    }

    //通过（左侧兵力编成）按钮获取棋子信息
    function chooseChesses()
    {
        ThisPiece = { //组件信息数组标准："information"：[id,name,health,defense,move_speed,cooling,armour,visibility]
            "information": [],
            "id": null,
            "weapon_id": [],
            "position":{},
        } //重置信息

        for(let key_red in map.red_chesses.children)
        {
            if(this.id == map.red_chesses.children[key_red].information[0])
            {
                ThisPiece.information = map.red_chesses.children[key_red].information;
                ThisPiece.weapon_id = map.red_chesses.children[key_red].weapon_id;

                ThisPiece.position["row"] = map.red_chesses.children[key_red].row;
                ThisPiece.position["col"] = map.red_chesses.children[key_red].colume; 
            }
        }

        console.log(ThisPiece);
        ClearElement("weapon_information");
        getweapon(ThisPiece.weapon_id);
    }

    //获取武器函数，并且将它们生成为按钮
    function getweapon(ThisPiece_weapon_id)
    {
    //清空当前武器表单
    for (var key in This_piece_weapon) {
            delete This_piece_weapon[key];
        }
    for (var key in weaponlist)
    {
        for (var i = 0; i < ThisPiece_weapon_id.length; i++) {
                if (ThisPiece_weapon_id[i] == key) {
                    This_piece_weapon[key] = weaponlist[key];
                    //console.log(This_piece_weapon);

                    //创建按钮
                    var weapon_information = document.getElementById("weapon_information");
                    var choose_weapon_button = document.createElement("button");

                    choose_weapon_button.type = "button"
                    choose_weapon_button.id = This_piece_weapon[key][0];
                    choose_weapon_button.innerHTML = "name: " + This_piece_weapon[key][1] + " attack: " + This_piece_weapon[key][2]
                    choose_weapon_button.onclick = choose_weapon;
                    weapon_information.appendChild(choose_weapon_button);
                }
            }
        }
    }

    //点击武器按钮后激活的函数，将点击的武器对应信息存储在公共变量choose_weapon_obj中
    function choose_weapon()
    {
        choose_weapon_obj = [];
        for (var key in weaponlist) {
            if (this.id == weaponlist[key][0]) {
                choose_weapon_obj = weaponlist[key];
                alert("you choose weapon: " + choose_weapon_obj[1]);
                break;
            }
        }
    }

    //每选取一次棋子，调用一次清除武器列表
    function ClearElement(ElementId) {
        var ThisElement = document.getElementById(ElementId);
        var childs = ThisElement.childNodes;

        for (let i = childs.length - 1; i >= 0; i--) {
            ThisElement.removeChild(childs[i]);
        }
    }

    //伤害计算公式
    function cal_harm() 
    {
        //EnemyPiece [id name health defense move_speed cooling armour visibility type]
        //Weapon [id name attack range anti_armoured cooling type] 7项
        //piece_type:1-轻单位 2-中型单位 3-重型单位
        //weapon_type:1-轻武器 2-火炮类武器 3-导弹类武器
        //轻单位（1）  ----对轻武器效果（1）：防御力*0.7----对火炮武器效果（2）：防御力*1.1----对导弹类武器效果（3）：防御力*1.5
        //中型单位（1）----对轻武器效果（1）：防御力*1.2----对火炮武器效果（2）：防御力*0.7----对导弹类武器效果（3）：防御力*0.8
        //重型单位（1）----对轻武器效果（1）：防御力*2  ----对火炮武器效果（2）：防御力*1.2----对导弹类武器效果（3）：防御力*0.6
        var this_enemy_type = EnemyPiece.information[8];
        var this_enemy_is_armour = EnemyPiece.information[6];
        var this_enemy_defense = EnemyPiece.information[3];

        var this_weapon_type = choose_weapon_obj[6];
        var this_weapon_anti_armour = choose_weapon_obj[4];
        var this_weapon_attack = choose_weapon_obj[2];
        //var this_weapon_range = choose_weapon_obj[3];
        var this_weapon_cooling = choose_weapon_obj[5];
        var harm_sum = 0;

        console.log("敌人类型：" + this_enemy_type + "敌人是否装甲单位：" + this_enemy_is_armour +
            "武器类型:" + this_enemy_type + "武器是否能击穿装甲单位：" + this_weapon_anti_armour);

        if (this_enemy_is_armour == true) {
            if (this_weapon_anti_armour == true) {
                switch (this_enemy_type) {
                    case 1: //轻单位（1）  ----对轻武器效果（1）：防御力*0.7----对火炮武器效果（2）：防御力*1.1----对导弹类武器效果（3）：防御力*1.5
                        switch (this_weapon_type) {
                            case 1:
                                harm_sum = Math.round(this_weapon_attack - (this_enemy_defense * 0.7));
                            case 2:
                                harm_sum = Math.round(this_weapon_attack - (this_enemy_defense * 1.1));
                            case 3:
                                harm_sum = Math.round(this_weapon_attack - (this_enemy_defense * 1.5));

                        };
                    case 2: //中型单位（1）----对轻武器效果（1）：防御力*1.2----对火炮武器效果（2）：防御力*0.7----对导弹类武器效果（3）：防御力*0.8
                        switch (this_weapon_type) {
                            case 1:
                                harm_sum = Math.round(this_weapon_attack - (this_enemy_defense * 1.2));
                            case 2:
                                harm_sum = Math.round(this_weapon_attack - (this_enemy_defense * 0.7));
                            case 3:
                                harm_sum = Math.round(this_weapon_attack - (this_enemy_defense * 0.8));
                        };
                    case 3: //重型单位（1）----对轻武器效果（1）：防御力*2  ----对火炮武器效果（2）：防御力*1.2----对导弹类武器效果（3）：防御力*0.6
                        switch (this_weapon_type) {
                            case 1:
                                harm_sum = Math.round(this_weapon_attack - (this_enemy_defense * 2));
                            case 2:
                                harm_sum = Math.round(this_weapon_attack - (this_enemy_defense * 1.2));
                            case 3:
                                harm_sum = Math.round(this_weapon_attack - (this_enemy_defense * 0.6));
                        };
                }
                return harm_sum;
            } else {
                return null;
            }
        } else {
            switch (this_enemy_type) {
                case 1: //轻单位（1）  ----对轻武器效果（1）：防御力*0.7----对火炮武器效果（2）：防御力*1.1----对导弹类武器效果（3）：防御力*1.5
                    switch (this_weapon_type) {
                        case 1:
                            harm_sum = Math.round(this_weapon_attack - (this_enemy_defense * 0.7));
                        case 2:
                            harm_sum = Math.round(this_weapon_attack - (this_enemy_defense * 1.1));
                        case 3:
                            harm_sum = Math.round(this_weapon_attack - (this_enemy_defense * 1.5));

                    };
                case 2: //中型单位（1）----对轻武器效果（1）：防御力*1.2----对火炮武器效果（2）：防御力*0.7----对导弹类武器效果（3）：防御力*0.8
                    switch (this_weapon_type) {
                        case 1:
                            harm_sum = Math.round(this_weapon_attack - (this_enemy_defense * 1.2));
                        case 2:
                            harm_sum = Math.round(this_weapon_attack - (this_enemy_defense * 0.7));
                        case 3:
                            harm_sum = Math.round(this_weapon_attack - (this_enemy_defense * 0.8));
                    };
                case 3: //重型单位（1）----对轻武器效果（1）：防御力*2  ----对火炮武器效果（2）：防御力*1.2----对导弹类武器效果（3）：防御力*0.6
                    switch (this_weapon_type) {
                        case 1:
                            harm_sum = Math.round(this_weapon_attack - (this_enemy_defense * 2));
                        case 2:
                            harm_sum = Math.round(this_weapon_attack - (this_enemy_defense * 1.2));
                        case 3:
                            harm_sum = Math.round(this_weapon_attack - (this_enemy_defense * 0.6));
                    };
            }
            return harm_sum;
        }
    }

    //假AI攻击，每10秒一次，伤害随机
    setInterval(Fake_AI_Attack,10000);

    //每秒调用一遍冷却计算
    setInterval(cal_cooling, 1000);
    //每0.1秒调用一次所有单位的移动
    setInterval(move_function, 100);
    //每秒刷新一下ThisPiece,以防位置信息和血量错误
    setInterval(Flash,1000);
    //每秒刷新一次信息显示
    setInterval(ShowInformation,1000);
    //每1秒计算一次分数
    setInterval(scoring,1000);
    //计时器
    setInterval(TimeScore,1000);
    //记录信息条,每秒都记录一边信息
    //setInterval(RePlay_Information_record,1000);





    //保存按钮，之后变成游戏结束自动保存
    const ExportInfor_botton = document.getElementById("exportInfor");
    ExportInfor_botton.addEventListener('click', e =>{
        SaveDate(ExportInfor_botton,e)
        },false);

    //保存数据
    function SaveDate(botton,event)
    {
        event.preventDefault();

        All_RePlay_Information["Chesses_Infor_obj"] = Chesses_Infor_obj;
        All_RePlay_Information["Replay_BroadCast_obj"] = Replay_BroadCast_obj;
        //const json = {"Information":Chesses_Infor_array};
        const blob = new Blob([JSON.stringify(All_RePlay_Information)], { type: 'application/json' });
        const url = window.URL.createObjectURL(blob);

        const link = document.createElement('a');
        link.href = url;
        link.setAttribute('download',"Information.txt");
        link.click();
    }

    //将许多时刻的播报数据转换成一个对象
    function getRePlayBroadCast(BroadCast)
    {
        String(BroadCast);
        Replay_BroadCast_array = [];
        Replay_BroadCast_array.push(BroadCast);
        Replay_BroadCast_array.push(time);

        Replay_BroadCast_obj[BroadCast_Key] = Replay_BroadCast_array;
        
        console.log(Replay_BroadCast_obj[BroadCast_Key]);
        BroadCast_Key +=1;
    }

    //将许多时刻的棋子信息转换成一个对象
    function getReplayInformation()
    {
        Chesses_Infor_array = [];

        for(let Blue_key in map.blue_chesses.children)
        {
            Chesses_Infor_array.push(map.blue_chesses.children[Blue_key].ThisToJson());
        }
        for(let Red_key in map.red_chesses.children)
        {
            Chesses_Infor_array.push(map.red_chesses.children[Red_key].ThisToJson());
        }
        Chesses_Infor_array.push(time);


        Chesses_Infor_obj[time] = Chesses_Infor_array;

        /* 
        {
            "ChesserInformation"
            {
            "1":[{},{},{},{},1]
            "2":[{},{},{},{},2]
            }
            
            "BroadCast"
            {
            "1":["xx干翻了xx", 1 ]
            "2":["xx被xx干烦了" , "xx也被xx干翻了" , 1]
            }
        }

        怎么样取数组最后一位呢？
        [length-1]则为最后一位!

        for(key in BoradCast)
        {
            if( BroadCast[key][BroadCast[key].length-1] == time)
            {
                for(let i = 0 ; i < BroadCast[key].length-1 ; i++)
                {
                    xxxxxx.innerHTML = BroadCast[key][i];
                }
            }
        }
         */

    }

        //地图绘制的函数
        map.Render();

        //window.addEventListener('keydown', (e) => {
        //     e.preventDefault();
        //     window.focus();
        // });
}






    //武器列表
    var weaponlist = {
        //[id name attack range anti_armoured cooling type] 7项
        //weapon_type:1-轻武器 2-火炮类武器 3-导弹类武器
        "21": [21, "tank_gun_heavy", 4, 11, true, 5, 2],
        "22": [22, "tank_gun_medium", 3, 10, true, 4, 2],
        "23": [23, "tank_light_machinegun", 4, 5, false, 5, 1],
        "24": [24, "infantry_machinegun", 3, 4, false, 5, 1],
        "25": [25, "missile", 6, 20, true, 15, 3],
        "26": [26, "infantry_missile", 5, 6, true, 10, 3],
    }
</script>



<script>



</script>
</html>